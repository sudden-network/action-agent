name: version-bump

on:
  pull_request:
    branches:
      - main
    types: [opened, reopened, synchronize, ready_for_review]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  version-bump:
    if: >-
      ${{
        (github.event_name == 'pull_request' &&
          !github.event.pull_request.draft &&
          github.event.pull_request.head.ref == 'develop' &&
          github.event.pull_request.head.repo.full_name == github.repository)
        ||
        (github.event_name == 'issue_comment' &&
          github.event.issue.pull_request &&
          (github.event.comment.author_association == 'OWNER' ||
           github.event.comment.author_association == 'MEMBER' ||
           github.event.comment.author_association == 'COLLABORATOR') &&
          github.event.issue.pull_request.head.ref == 'develop' &&
          github.event.issue.pull_request.head.repo.full_name == github.repository)
      }}
    runs-on: ubuntu-latest
    steps:
      - name: Version bump via workflow-agent
        uses: sudden-network/workflow-agent@v1
        with:
          agent_api_key: ${{ secrets.OPENAI_API_KEY }}
          github_token: ${{ github.token }}
          resume: true
          prompt: |
            Goal: keep the package.json version aligned with the impact of changes.

            Review the PR changes and decide whether a version bump is needed:
            - Breaking changes -> major.
            - New backward compatible features -> minor.
            - Backward compatible bug fixes, security fixes, dependency updates -> patch.
            - Internal-only changes -> none.

            If you recommend a bump:
            - Comment on the PR with a short summary and rationale, plus the recommended bump: major|minor|patch.
            - Include the current version and the proposed version in a diff-style code fence:
              ```diff
              - version: <current>
              + version: <proposed>
              ```
            - Ask the PR author to confirm before applying the bump.

            If the PR author confirms the bump:
            - Ensure the commenter matches the PR author and is a trusted collaborator.
            - Bump package.json on the PR branch:
              major -> X+1.0.0, minor -> X.Y+1.0, patch -> X.Y.Z+1.
              PUT /repos/{owner}/{repo}/contents/package.json
              { "message": "Bump version to v<new>", "content": "<base64>", "sha": "<file sha>", "branch": "<head.ref>" }
