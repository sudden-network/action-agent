#!/usr/bin/env bash
set -euo pipefail

body=""
issue=""
pr=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --body)
      body="$2"
      shift 2
      ;;
    --issue)
      issue="$2"
      shift 2
      ;;
    --pr)
      pr="$2"
      shift 2
      ;;
    --help)
      echo "Usage: comment-create --body \"text\" [--issue N|--pr N]" >&2
      exit 0
      ;;
    *)
      echo "Unknown argument: $1" >&2
      exit 1
      ;;
  esac
 done

if [[ -z "$body" ]]; then
  echo "comment-create: --body is required" >&2
  exit 1
fi

get_number() {
  if [[ -n "$issue" ]]; then
    echo "$issue"
    return
  fi
  if [[ -n "$pr" ]]; then
    echo "$pr"
    return
  fi
  node - <<'NODE'
const fs = require('fs');
const eventPath = process.env.GITHUB_EVENT_PATH;
const eventName = process.env.GITHUB_EVENT_NAME;
if (!eventPath) process.exit(1);
const payload = JSON.parse(fs.readFileSync(eventPath, 'utf8'));
let number = null;
if (eventName === 'issues' || eventName === 'issue_comment') {
  number = payload.issue?.number ?? null;
}
if (eventName && eventName.startsWith('pull_request')) {
  number = payload.pull_request?.number ?? null;
}
if (!number) process.exit(1);
console.log(number);
NODE
}

number=$(get_number)
if [[ -z "$number" ]]; then
  echo "comment-create: issue/pr number not found" >&2
  exit 1
fi

repo="${GITHUB_REPOSITORY:?GITHUB_REPOSITORY is required}"

gh api -X POST "repos/$repo/issues/$number/comments" -f body="$body"
