#!/usr/bin/env bash
set -euo pipefail

pr=""
since=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --pr)
      pr="$2"
      shift 2
      ;;
    --since)
      since="$2"
      shift 2
      ;;
    --help)
      echo "Usage: pr-comments --pr N [--since ISO8601]" >&2
      exit 0
      ;;
    *)
      echo "Unknown argument: $1" >&2
      exit 1
      ;;
  esac
 done

if [[ -z "$pr" ]]; then
  pr=$(node - <<'NODE'
const fs = require('fs');
const eventPath = process.env.GITHUB_EVENT_PATH;
if (!eventPath) process.exit(1);
const payload = JSON.parse(fs.readFileSync(eventPath, 'utf8'));
const number = payload.pull_request?.number ?? payload.issue?.number;
if (!number) process.exit(1);
console.log(number);
NODE
  )
fi

repo="${GITHUB_REPOSITORY:?GITHUB_REPOSITORY is required}"

if [[ -n "$since" ]]; then
  gh api "repos/$repo/issues/$pr/comments" -f since="$since"
else
  gh api "repos/$repo/issues/$pr/comments"
fi
